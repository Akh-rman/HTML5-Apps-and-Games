var GF=function(){var e,t,a,n,o,s,i={},d={mainMenu:0,gameRunning:1,gameOver:2},r=d.gameRunning,l=1,c=5e3,u={x:10,y:10,width:50,height:50,speed:100,dead:!1},h=[],m=5;function g(){var e;!function(){for(var e=navigator.getGamepads(),t=0;t<e.length;t++)e[t]&&(o=e[t])}(),function(e){if(void 0!==e&&e.connected)for(var t=0;t<e.buttons.length;t++){var a=e.buttons[t];a.pressed&&(console.log("button pressed"),void 0!==a.value&&console.log("analog button pressed"))}}(o),void 0!==(e=o)&&e.connected&&(i.left=i.right=i.up=i.down=!1,e.axes[0]>.5?(i.right=!0,i.left=!1):e.axes[0]<-.5&&(i.left=!0,i.right=!1),e.axes[1]>.5?(i.down=!0,i.up=!1):e.axes[1]<-.5&&(i.up=!0,i.down=!1),i.angle=Math.atan2(-e.axes[1],e.axes[0]))}function v(e){h=[];for(var t=0;t<e;t++){var o=new Ball(a*Math.random(),n*Math.random(),2*Math.PI*Math.random(),80*Math.random(),30);circRectsOverlap(u.x,u.y,u.width,u.height,o.x,o.y,3*o.radius)?t--:h[t]=o}}window.addEventListener("gamepadconnected",function(e){var t=(o=e.gamepad).index,a=o.id,n=o.buttons.length,s=o.axes.length;console.log("Gamepad № "+t+", with id "+a+" is connected. It has "+n+" buttons and "+s+" axes")}),window.addEventListener("gamepaddisconnected",function(e){var t=e.gamepad.index;console.log("Gamepad № "+t+" has been disconnected")});var f=function(o){switch(measureFps(o),delta=timer(o),t.clearRect(0,0,a,n),g(),u.dead&&(r=d.gameOver),r){case d.gameRunning:x=u.x,w=u.y,t.save(),t.translate(x,w),t.scale(.5,.5),t.strokeRect(0,0,2*u.width,2*u.height),t.fillRect(20,20,10,10),t.fillRect(65,20,10,10),t.strokeRect(45,40,10,40),t.strokeRect(35,84,30,10),t.fillRect(38,84,10,10),t.fillRect(52,84,10,10),t.restore(),p=delta,u.speedX=u.speedY=0,i.left&&u.x>0&&(u.speedX=-u.speed),i.up&&u.y>0&&(u.speedY=-u.speed),i.right&&u.x+u.width<e.width&&(u.speedX=u.speed),i.down&&u.y+u.height<e.height&&(u.speedY=u.speed),i.space&&t.fillText("space bar",140,150),i.mousePos,i.mousedown?u.speed=500:u.speed=100,u.x+=calcDistanceToMove(p,u.speedX),u.y+=calcDistanceToMove(p,u.speedY),function(e){for(var o=0;o<h.length;o++){var i=h[o];i.move(),testCollisionWithWalls(i,a,n),circRectsOverlap(u.x,u.y,u.width,u.height,i.x,i.y,i.radius)&&(i.color="red",u.dead=!0,s.play()),i.draw(t)}}(),t.save(),t.fillStyle="Green",t.fillText("Level "+l,300,30),t.fillText("Time "+(c/1e3).toFixed(1),300,60),t.fillText("Balls "+m,300,90),t.restore(),(c-=delta)<0&&(c=5e3,l++,v(m+=2));break;case d.mainMenu:break;case d.gameOver:t.fillText("Game OVER",50,100),t.fillText("Press SPACE to start again",50,150),t.fillText("Move with arrow keys",50,200),t.fillText("Survive 5 seconds for next level",50,250),i.space&&(u.dead=!1,c=5e3,l=1,v(m=5),r=d.gameRunning)}var p,x,w;requestAnimationFrame(f)};return{start:function(o){var d;e=document.querySelector("#myCanvas"),initFPSCounter(e),a=e.width,n=e.height,(t=e.getContext("2d")).font="20px Arial",addListeners(i,e),v(m),d=(()=>{requestAnimationFrame(f)}),s=new Howl({urls:["https://mainline.i3s.unice.fr/mooc/plop.mp3"],autoplay:!1,volume:1,onload:()=>{console.log("All sounds loaded"),d()}})}}};window.onload=function(){(new GF).start()};class Ball{constructor(e,t,a,n,o){this.x=e,this.y=t,this.angle=a,this.v=n,this.radius=o/2,this.dead=!1}draw(e){e.save(),e.beginPath(),e.fillStyle=this.color,e.arc(this.x,this.y,this.radius,0,2*Math.PI),e.fill(),e.restore(),this.color="black"}move(){var e=this.v*Math.cos(this.angle),t=this.v*Math.sin(this.angle);this.x+=calcDistanceToMove(delta,e),this.y+=calcDistanceToMove(delta,t)}}var delta,oldTime=0;function timer(e){var t=e-oldTime;return oldTime=e,t}var lastTime,fpsContainer,fps,calcDistanceToMove=(e,t)=>t*e/1e3,frameCount=0,initFPSCounter=e=>{fpsContainer=document.createElement("div"),document.body.insertBefore(fpsContainer,e)},measureFps=e=>{void 0!=lastTime?(e-lastTime>=1e3&&(fps=frameCount,frameCount=0,lastTime=e),fpsContainer.innerHTML="FPS "+fps,frameCount++):lastTime=e};function addListeners(e,t){window.addEventListener("keydown",t=>{37===t.keyCode?e.left=!0:38===t.keyCode?e.up=!0:39===t.keyCode?e.right=!0:40===t.keyCode?e.down=!0:32===t.keyCode&&(e.space=!0)},!1),window.addEventListener("keyup",t=>{37===t.keyCode?e.left=!1:38===t.keyCode?e.up=!1:39===t.keyCode?e.right=!1:40===t.keyCode?e.down=!1:32===t.keyCode&&(e.space=!1)},!1),t.addEventListener("mousemove",a=>{e.mousePos=getMousePos(a,t)},!1),t.addEventListener("mousedown",t=>{e.mousedown=!0,e.mouseButton=t.button},!1),t.addEventListener("mouseup",t=>{e.mousedown=!1},!1)}function getMousePos(e,t){var a=t.getBoundingClientRect();return{x:e.clientX-a.left,y:e.clientY-a.top}}function circRectsOverlap(e,t,a,n,o,s,i){var d=o,r=s;return d<e&&(d=e),d>e+a&&(d=e+a),r<t&&(r=t),r>t+n&&(r=t+n),(o-d)*(o-d)+(s-r)*(s-r)<i*i}function testCollisionWithWalls(e,t,a){e.x<e.radius&&(e.x=e.radius,e.angle=-e.angle+Math.PI),e.x>t-e.radius&&(e.x=t-e.radius,e.angle=-e.angle+Math.PI),e.y<e.radius&&(e.y=e.radius,e.angle=-e.angle),e.y>a-e.radius&&(e.y=a-e.radius,e.angle=-e.angle)}fgfg;